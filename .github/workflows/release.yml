name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

permissions:
  contents: write


jobs:
  test:
    name: Test
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

    - name: Build
      run: swift build -v

    - name: Run tests (if available)
      run: |
        if [ -d "Tests" ]; then
          swift test -v
        else
          echo "No tests directory found, skipping tests"
        fi

  build:
    name: Build Release Binary
    runs-on: macos-latest
    needs: test
    if: github.event_name == 'release'
    strategy:
      matrix:
        include:
          - platform: macos
            arch: x86_64
            sdk: macosx
            destination: generic/platform=macOS
          - platform: macos
            arch: arm64
            sdk: macosx
            destination: generic/platform=macOS,variant=Mac Catalyst

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

    - name: Build for ${{ matrix.platform }}-${{ matrix.arch }}
      run: |
        swift build -c release --arch ${{ matrix.arch }}

    - name: Create artifact directory
      run: |
        mkdir -p artifacts

    - name: Create .app bundle
      run: |
        # Create .app directory structure
        mkdir -p artifacts/PentaKill.app/Contents/MacOS
        mkdir -p artifacts/PentaKill.app/Contents/Resources

        # Copy and modify Info.plist
        sed -e 's/$(DEVELOPMENT_LANGUAGE)/en/' \
            -e 's/$(EXECUTABLE_NAME)/PentaKill/' \
            -e 's/$(PRODUCT_BUNDLE_IDENTIFIER)/com.github.pentakill/' \
            -e 's/$(MACOSX_DEPLOYMENT_TARGET)/13.0/' \
            -e 's/<string>icon<\/string>/<string>PentaKill<\/string>/' \
            Info.plist > artifacts/PentaKill.app/Contents/Info.plist

        # Copy executable
        cp .build/release/PentaKill artifacts/PentaKill.app/Contents/MacOS/

        # Create PkgInfo file
        echo "APPL????" > artifacts/PentaKill.app/Contents/PkgInfo

        # Create icon set if icon exists
        if [ -f "icon.png" ]; then
          mkdir -p artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset

          # Create icon in different sizes
          sips -z 16 16 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_16x16.png 2>/dev/null || true
          sips -z 32 32 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_16x16@2x.png 2>/dev/null || true
          sips -z 32 32 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_32x32.png 2>/dev/null || true
          sips -z 64 64 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_32x32@2x.png 2>/dev/null || true
          sips -z 128 128 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_128x128.png 2>/dev/null || true
          sips -z 256 256 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_128x128@2x.png 2>/dev/null || true
          sips -z 256 256 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_256x256.png 2>/dev/null || true
          sips -z 512 512 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_256x256@2x.png 2>/dev/null || true
          sips -z 512 512 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_512x512.png 2>/dev/null || true
          sips -z 1024 1024 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_512x512@2x.png 2>/dev/null || true

          # Create icns file
          iconutil -c icns artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset 2>/dev/null || {
            # Fallback: copy original icon as icon.png
            cp icon.png artifacts/PentaKill.app/Contents/Resources/
          }
        fi

        # Set executable permissions
        chmod +x artifacts/PentaKill.app/Contents/MacOS/PentaKill

    - name: Create archives
      run: |
        # Create .app archive
        tar -czvf artifacts/PentaKill-${{ matrix.arch }}.app.tar.gz -C artifacts PentaKill.app

        # Also create standalone binary archive
        cp .build/release/PentaKill artifacts/PentaKill-${{ matrix.arch }}
        tar -czvf artifacts/PentaKill-${{ matrix.arch }}.tar.gz -C artifacts PentaKill-${{ matrix.arch }}

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/PentaKill-${{ matrix.arch }}.tar.gz
          artifacts/PentaKill-${{ matrix.arch }}.app.tar.gz

  create-universal-binary:
    name: Create Universal Binary
    runs-on: macos-latest
    needs: test
    if: github.event_name == 'release'
    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

    - name: Build for x86_64
      run: |
        swift build -c release --arch x86_64
        mkdir -p .build/x86_64-backup
        cp .build/release/PentaKill .build/x86_64-backup/

    - name: Build for arm64
      run: |
        swift build -c release --arch arm64

    - name: Create universal binary
      run: |
        lipo -create \
          .build/x86_64-backup/PentaKill \
          .build/release/PentaKill \
          -output .build/release/PentaKill-universal

    - name: Create artifact directory
      run: |
        mkdir -p artifacts

    - name: Create universal .app bundle
      run: |
        # Create .app directory structure
        mkdir -p artifacts/PentaKill.app/Contents/MacOS
        mkdir -p artifacts/PentaKill.app/Contents/Resources

        # Copy and modify Info.plist
        sed -e 's/$(DEVELOPMENT_LANGUAGE)/en/' \
            -e 's/$(EXECUTABLE_NAME)/PentaKill/' \
            -e 's/$(PRODUCT_BUNDLE_IDENTIFIER)/com.github.pentakill/' \
            -e 's/$(MACOSX_DEPLOYMENT_TARGET)/13.0/' \
            -e 's/<string>icon<\/string>/<string>PentaKill<\/string>/' \
            Info.plist > artifacts/PentaKill.app/Contents/Info.plist

        # Copy universal executable
        cp .build/release/PentaKill-universal artifacts/PentaKill.app/Contents/MacOS/PentaKill

      # Create PkgInfo file
      echo "APPL????" > artifacts/PentaKill.app/Contents/PkgInfo

      # Create icon set if icon exists
        if [ -f "icon.png" ]; then
          mkdir -p artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset

          # Create icon in different sizes
          sips -z 16 16 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_16x16.png 2>/dev/null || true
          sips -z 32 32 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_16x16@2x.png 2>/dev/null || true
          sips -z 32 32 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_32x32.png 2>/dev/null || true
          sips -z 64 64 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_32x32@2x.png 2>/dev/null || true
          sips -z 128 128 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_128x128.png 2>/dev/null || true
          sips -z 256 256 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_128x128@2x.png 2>/dev/null || true
          sips -z 256 256 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_256x256.png 2>/dev/null || true
          sips -z 512 512 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_256x256@2x.png 2>/dev/null || true
          sips -z 512 512 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_512x512.png 2>/dev/null || true
          sips -z 1024 1024 icon.png --out artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset/icon_512x512@2x.png 2>/dev/null || true

          # Create icns file
          iconutil -c icns artifacts/PentaKill.app/Contents/Resources/PentaKill.iconset 2>/dev/null || {
            # Fallback: copy original icon as icon.png
            cp icon.png artifacts/PentaKill.app/Contents/Resources/
          }
        fi

        # Set executable permissions
        chmod +x artifacts/PentaKill.app/Contents/MacOS/PentaKill

    - name: Create universal archives
      run: |
        # Create .app archive
        tar -czvf artifacts/PentaKill-universal.app.tar.gz -C artifacts PentaKill.app

        # Also create standalone binary archive
        cp .build/release/PentaKill-universal artifacts/PentaKill-universal
        tar -czvf artifacts/PentaKill-universal.tar.gz -C artifacts PentaKill-universal

    - name: Upload Universal Binary Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/PentaKill-universal.tar.gz
          artifacts/PentaKill-universal.app.tar.gz

  build-snapshot:
    name: Build Snapshot
    runs-on: macos-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: Build
      run: |
        swift build -c release

    - name: Create snapshot archive
      run: |
        mkdir -p artifacts
        cp .build/release/PentaKill artifacts/PentaKill-snapshot-${{ steps.date.outputs.date }}
        tar -czvf artifacts/PentaKill-snapshot-${{ steps.date.outputs.date }}.tar.gz -C artifacts PentaKill-snapshot-${{ steps.date.outputs.date }}

    - name: Upload snapshot artifact
      uses: actions/upload-artifact@v4
      with:
        name: PentaKill-snapshot
        path: artifacts/PentaKill-snapshot-${{ steps.date.outputs.date }}.tar.gz
        retention-days: 30